<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Click2GO â€“ Agentic Travel Planner</title>
<style>
/* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --red:    #E8335D;
  --red-lt: #FFF0F3;
  --red-dk: #C0284E;
  --gray:   #6B7280;
  --border: #E5E7EB;
  --bg:     #FAFAFA;
  --white:  #FFFFFF;
  --text:   #1F2937;
  --radius: 14px;
  --shadow: 0 4px 20px rgba(0,0,0,.08);
}
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
       background: var(--bg); color: var(--text); min-height: 100vh; }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 2rem;
  display: flex; align-items: center; gap: 1rem;
  height: 64px; position: sticky; top: 0; z-index: 100;
}
.logo { font-size: 1.6rem; font-weight: 800; color: var(--red); letter-spacing: -.5px; }
.logo span { color: var(--text); }
.tagline { color: var(--gray); font-size: .85rem; }

/* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main { max-width: 820px; margin: 0 auto; padding: 2.5rem 1.5rem 4rem; }

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--white); border-radius: var(--radius);
  box-shadow: var(--shadow); padding: 2rem;
  margin-bottom: 1.5rem;
}
.card-title {
  font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem;
  display: flex; align-items: center; gap: .5rem;
}

/* â”€â”€ Form elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field { margin-bottom: 1.25rem; }
label { display: block; font-size: .875rem; font-weight: 600;
        color: var(--text); margin-bottom: .4rem; }
input[type="text"], input[type="date"], select {
  width: 100%; padding: .65rem .9rem;
  border: 1.5px solid var(--border); border-radius: 8px;
  font-size: .95rem; outline: none; transition: border .15s;
  background: var(--white); color: var(--text);
}
input:focus, select:focus { border-color: var(--red); }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }

/* â”€â”€ Persona picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.persona-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: .75rem; }
.persona-card {
  border: 2px solid var(--border); border-radius: 10px;
  padding: .85rem .5rem; text-align: center; cursor: pointer;
  transition: border .15s, background .15s;
}
.persona-card input { display: none; }
.persona-card .icon { font-size: 1.8rem; display: block; margin-bottom: .35rem; }
.persona-card .pname { font-size: .8rem; font-weight: 600; color: var(--gray); }
.persona-card:has(input:checked) {
  border-color: var(--red); background: var(--red-lt);
}
.persona-card:has(input:checked) .pname { color: var(--red); }

/* â”€â”€ Submit button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-primary {
  background: var(--red); color: #fff; border: none;
  padding: .85rem 2.5rem; border-radius: 10px; font-size: 1rem;
  font-weight: 700; cursor: pointer; transition: background .15s, transform .1s;
  display: flex; align-items: center; gap: .5rem;
}
.btn-primary:hover  { background: var(--red-dk); }
.btn-primary:active { transform: scale(.97); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }

.btn-secondary {
  background: var(--white); color: var(--red);
  border: 2px solid var(--red); border-radius: 10px;
  padding: .6rem 1.4rem; font-size: .9rem; font-weight: 700;
  cursor: pointer; transition: background .15s;
  display: inline-flex; align-items: center; gap: .4rem;
  text-decoration: none;
}
.btn-secondary:hover { background: var(--red-lt); }

/* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#progress-section { display: none; }
.progress-bar-wrap {
  background: var(--border); border-radius: 99px; height: 8px; overflow: hidden;
  margin: 1rem 0 .5rem;
}
.progress-bar {
  height: 100%; background: var(--red); border-radius: 99px;
  transition: width .4s ease;
}
.progress-msg { font-size: .9rem; color: var(--gray); text-align: center; min-height: 1.2em; }
.progress-steps {
  display: flex; justify-content: space-between; margin-top: 1.5rem;
}
.step {
  display: flex; flex-direction: column; align-items: center; gap: .3rem;
  font-size: .75rem; color: var(--gray); flex: 1;
  position: relative;
}
.step::before {
  content: ''; position: absolute; top: 12px; left: calc(-50% + 16px);
  right: calc(50% + 16px); height: 2px; background: var(--border);
}
.step:first-child::before { display: none; }
.step .dot {
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--border); display: flex; align-items: center;
  justify-content: center; font-size: .85rem; z-index: 1;
  transition: background .3s;
}
.step.done .dot   { background: var(--red); }
.step.done        { color: var(--red); }
.step.active .dot { background: var(--red); animation: pulse 1s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(232,51,93,.4)}
                   50%{box-shadow:0 0 0 8px rgba(232,51,93,0)} }

/* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#results-section { display: none; }
.stats-row {
  display: grid; grid-template-columns: repeat(3,1fr); gap: 1rem;
  margin-bottom: 1.5rem;
}
.stat-box {
  background: var(--red-lt); border-radius: 10px;
  padding: .9rem; text-align: center;
}
.stat-box .num { font-size: 2rem; font-weight: 800; color: var(--red); }
.stat-box .lbl { font-size: .75rem; color: var(--gray); font-weight: 600; margin-top: .15rem; }

.day-block { margin-bottom: 1.5rem; }
.day-header {
  font-size: 1.05rem; font-weight: 700; color: var(--red);
  border-left: 4px solid var(--red);
  padding-left: .75rem; margin-bottom: .75rem;
}

.poi-card {
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 10px; padding: 1rem 1.1rem;
  margin-bottom: .6rem; display: flex; gap: 1rem; align-items: flex-start;
}
.poi-num {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--red); color: #fff;
  font-size: .8rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: .15rem;
}
.poi-body { flex: 1; min-width: 0; }
.poi-name { font-weight: 700; font-size: .98rem; margin-bottom: .2rem; }
.poi-address { font-size: .8rem; color: var(--gray); margin-bottom: .35rem; }
.poi-meta { display: flex; gap: .75rem; flex-wrap: wrap; margin-bottom: .35rem; }
.badge {
  font-size: .72rem; font-weight: 600; padding: .15rem .55rem;
  border-radius: 99px; white-space: nowrap;
}
.badge-open   { background: #D1FAE5; color: #065F46; }
.badge-closed { background: #FEE2E2; color: #991B1B; }
.badge-unknown{ background: var(--border); color: var(--gray); }
.badge-score  { background: #EDE9FE; color: #5B21B6; }
.poi-note { font-size: .82rem; color: var(--gray); font-style: italic;
            border-left: 3px solid var(--red-lt); padding-left: .6rem; }

.actions-row { display: flex; gap: .75rem; flex-wrap: wrap; margin-top: 1.5rem; }

/* â”€â”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.error-box {
  background: #FEE2E2; border: 1px solid #FCA5A5;
  border-radius: 10px; padding: 1rem 1.2rem;
  color: #991B1B; font-size: .9rem; display: none;
}

</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
  <div class="logo">Click<span>2GO</span></div>
  <div class="tagline">Agentic Travel Planner Â· Powered by Xiaohongshu + Claude AI</div>
</header>

<main>

<!-- â”€â”€ Planning form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card" id="form-section">
  <div class="card-title">ğŸ—ºï¸ Plan your trip</div>

  <div class="field">
    <label>Destination</label>
    <input type="text" id="destination" placeholder="e.g. Tokyo Â· ä¸œäº¬ Â· Paris Â· Singapore" />
  </div>

  <div class="row-2">
    <div class="field">
      <label>Start date</label>
      <input type="date" id="start-date" onchange="updateEndDate()" />
    </div>
    <div class="field">
      <label>Trip duration</label>
      <select id="duration" onchange="updateEndDate()">
        <option value="1">1 day</option>
        <option value="2">2 days</option>
        <option value="3" selected>3 days</option>
        <option value="4">4 days</option>
        <option value="5">5 days</option>
        <option value="6">6 days</option>
        <option value="7">1 week</option>
        <option value="10">10 days</option>
        <option value="14">2 weeks</option>
        <option value="21">3 weeks</option>
        <option value="30">1 month</option>
      </select>
    </div>
  </div>
  <div class="field" style="margin-top:-.5rem">
    <span style="font-size:.82rem;color:var(--gray)">
      Trip ends: <b id="end-date-display">â€”</b>
    </span>
  </div>

  <div class="field">
    <label>Travel style <span style="font-size:.8rem;font-weight:400;color:var(--gray)">(pick one or more)</span></label>
    <div class="persona-grid">
      <label class="persona-card">
        <input type="checkbox" name="persona" value="photography" />
        <span class="icon">ğŸ“·</span>
        <span class="pname">Photography</span>
      </label>
      <label class="persona-card">
        <input type="checkbox" name="persona" value="chilling" checked />
        <span class="icon">â˜•</span>
        <span class="pname">Chilling</span>
      </label>
      <label class="persona-card">
        <input type="checkbox" name="persona" value="foodie" />
        <span class="icon">ğŸœ</span>
        <span class="pname">Foodie</span>
      </label>
      <label class="persona-card">
        <input type="checkbox" name="persona" value="exercise" />
        <span class="icon">ğŸ¥¾</span>
        <span class="pname">Exercise</span>
      </label>
    </div>
  </div>

  <div class="row-3">
    <div class="field">
      <label>Budget</label>
      <select id="budget">
        <option value="">Any</option>
        <option value="budget">Budget ğŸ’°</option>
        <option value="mid-range">Mid-range ğŸ’°ğŸ’°</option>
        <option value="luxury">Luxury ğŸ’°ğŸ’°ğŸ’°</option>
      </select>
    </div>
    <div class="field">
      <label>Max stops / day</label>
      <select id="max-pois">
        <option value="3">3 stops</option>
        <option value="4">4 stops</option>
        <option value="5" selected>5 stops</option>
        <option value="6">6 stops</option>
      </select>
    </div>
    <div class="field">
      <label>Language</label>
      <select id="language">
        <option value="en">English</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>
  </div>

  <div class="field">
    <label>Allergies / dietary restrictions (comma-separated)</label>
    <input type="text" id="allergies" placeholder="e.g. nuts, shellfish, gluten" />
  </div>

  <div class="error-box" id="form-error"></div>

  <button class="btn-primary" id="plan-btn" onclick="startPlanning()">
    âœˆï¸ Generate my itinerary
  </button>
</div>

<!-- â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card" id="progress-section">
  <div class="card-title">â³ Building your itineraryâ€¦</div>

  <div class="progress-bar-wrap">
    <div class="progress-bar" id="progress-bar" style="width:0%"></div>
  </div>
  <p class="progress-msg" id="progress-msg">Initialisingâ€¦</p>

  <div class="progress-steps">
    <div class="step" id="step-scraping">
      <div class="dot">ğŸ”</div><span>Discover</span>
    </div>
    <div class="step" id="step-verifying">
      <div class="dot">ğŸ¤–</div><span>Verify</span>
    </div>
    <div class="step" id="step-routing">
      <div class="dot">ğŸ“</div><span>Route</span>
    </div>
    <div class="step" id="step-exporting">
      <div class="dot">ğŸ“„</div><span>Export</span>
    </div>
  </div>
</div>

<!-- â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="results-section">
  <div class="card">
    <div class="card-title">ğŸ‰ Your itinerary is ready!</div>

    <div class="stats-row">
      <div class="stat-box">
        <div class="num" id="stat-scraped">â€“</div>
        <div class="lbl">POIs Discovered</div>
      </div>
      <div class="stat-box">
        <div class="num" id="stat-verified">â€“</div>
        <div class="lbl">AI-Verified</div>
      </div>
      <div class="stat-box">
        <div class="num" id="stat-included">â€“</div>
        <div class="lbl">Included</div>
      </div>
    </div>

    <div id="itinerary-body"></div>

    <div class="actions-row" id="actions-row"></div>
  </div>
</div>


</main>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pollTimer = null;
let currentSessionId = null;

// â”€â”€ Date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pad = n => String(n).padStart(2,'0');
const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const fmtDisplay = d => d.toLocaleDateString('en', {weekday:'short', month:'short', day:'numeric', year:'numeric'});

function updateEndDate() {
  const startVal = document.getElementById('start-date').value;
  const days     = parseInt(document.getElementById('duration').value);
  if (!startVal) return;
  const end = new Date(startVal + 'T00:00:00');
  end.setDate(end.getDate() + days - 1);
  document.getElementById('end-date-display').textContent = fmtDisplay(end);
}

// Initialise defaults
(function () {
  const today = new Date();
  document.getElementById('start-date').value = fmt(today);
  updateEndDate();
})();

// â”€â”€ Form submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startPlanning() {
  const dest      = document.getElementById('destination').value.trim();
  const startDate = document.getElementById('start-date').value;
  const duration  = parseInt(document.getElementById('duration').value);
  const budget    = document.getElementById('budget').value;
  const maxPois   = parseInt(document.getElementById('max-pois').value);
  const language  = document.getElementById('language').value;
  const allergyRaw = document.getElementById('allergies').value;
  const allergies = allergyRaw ? allergyRaw.split(',').map(s => s.trim()).filter(Boolean) : [];

  // Collect checked personas
  const personas = Array.from(document.querySelectorAll('input[name="persona"]:checked'))
                        .map(el => el.value);

  // Compute end date from start + duration
  const startDt = new Date(startDate + 'T00:00:00');
  const endDt   = new Date(startDt);
  endDt.setDate(startDt.getDate() + duration - 1);
  const endDate = fmt(endDt);

  // Validate
  const err = document.getElementById('form-error');
  err.style.display = 'none';
  if (!dest)           { showError('Please enter a destination.'); return; }
  if (!startDate)      { showError('Please pick a start date.');   return; }
  if (personas.length === 0) { showError('Please select at least one travel style.'); return; }

  const payload = {
    destination:      dest,
    start_date:       startDate,
    end_date:         endDate,
    personas:         personas,
    constraints:      { allergies, budget: budget || null },
    max_pois_per_day: maxPois,
    language:         language,
  };

  // UI: disable form, show progress
  document.getElementById('plan-btn').disabled = true;
  document.getElementById('plan-btn').textContent = 'â³ Planningâ€¦';
  document.getElementById('progress-section').style.display = 'block';
  document.getElementById('results-section').style.display  = 'none';
  document.getElementById('progress-section').scrollIntoView({ behavior: 'smooth' });

  try {
    const res = await fetch('/api/v1/plan', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload),
    });
    if (!res.ok) {
      const detail = await res.json();
      throw new Error(detail.detail || 'Server error');
    }
    const data = await res.json();
    currentSessionId = data.session_id;
    pollStatus(currentSessionId);
  } catch (e) {
    showError(e.message);
    resetBtn();
  }
}

// â”€â”€ Status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATUS_STEPS = {
  pending:   { pct: 5,  step: '',           msg: 'Initialising sessionâ€¦' },
  scraping:  { pct: 25, step: 'scraping',   msg: 'Discovering POIs from Xiaohongshuâ€¦' },
  verifying: { pct: 55, step: 'verifying',  msg: 'Running AI Reality Check on each locationâ€¦' },
  routing:   { pct: 75, step: 'routing',    msg: 'Optimising daily route with K-Meansâ€¦' },
  exporting: { pct: 90, step: 'exporting',  msg: 'Generating PDF and interactive mapâ€¦' },
  completed: { pct: 100, step: 'exporting', msg: 'Done! Fetching your itineraryâ€¦' },
  failed:    { pct: 0,   step: '',          msg: 'Something went wrong.' },
};

const STEP_ORDER = ['scraping','verifying','routing','exporting'];

function setProgress(status) {
  const info = STATUS_STEPS[status] || { pct: 0, step: '', msg: status };
  document.getElementById('progress-bar').style.width = info.pct + '%';
  document.getElementById('progress-msg').textContent = info.msg;

  const stepIdx = STEP_ORDER.indexOf(info.step);
  STEP_ORDER.forEach((s, i) => {
    const el = document.getElementById(`step-${s}`);
    el.className = 'step';
    if (i < stepIdx) el.className = 'step done';
    if (i === stepIdx) el.className = 'step active';
  });
}

async function pollStatus(sessionId) {
  try {
    const res  = await fetch(`/api/v1/plan/${sessionId}/status`);
    const data = await res.json();
    setProgress(data.status);

    if (data.status === 'completed') {
      clearTimeout(pollTimer);
      await fetchResult(sessionId);
    } else if (data.status === 'failed') {
      clearTimeout(pollTimer);
      showError(data.error_message || 'Planning failed. Check if the Xiaohongshu server is running.');
      resetBtn();
    } else {
      pollTimer = setTimeout(() => pollStatus(sessionId), 2500);
    }
  } catch (e) {
    pollTimer = setTimeout(() => pollStatus(sessionId), 3000);
  }
}

// â”€â”€ Fetch & render result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchResult(sessionId) {
  try {
    const res  = await fetch(`/api/v1/plan/${sessionId}/result`);
    const data = await res.json();
    renderResult(data);
  } catch (e) {
    showError('Could not fetch the result: ' + e.message);
    resetBtn();
  }
}

function renderResult(data) {
  // Stats
  const s = data.stats || {};
  document.getElementById('stat-scraped').textContent   = s.total_scraped  ?? 'â€“';
  document.getElementById('stat-verified').textContent  = s.total_verified ?? 'â€“';
  document.getElementById('stat-included').textContent  = s.total_included ?? 'â€“';

  // Days
  const body = document.getElementById('itinerary-body');
  body.innerHTML = '';
  const days = data.itinerary || [];

  if (days.length === 0) {
    body.innerHTML = '<p style="color:var(--gray);text-align:center;padding:2rem">No POIs returned. Try a different destination or broaden your search.</p>';
  }

  days.forEach(day => {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day-block';

    const header = document.createElement('div');
    header.className = 'day-header';
    header.textContent = `Day ${day.day_number}`;
    if (day.date) header.textContent += `  Â·  ${formatDate(day.date)}`;
    dayDiv.appendChild(header);

    (day.pois || []).forEach((poi, idx) => {
      const card = document.createElement('div');
      card.className = 'poi-card';

      // Colour dot
      const num = document.createElement('div');
      num.className = 'poi-num';
      num.textContent = idx + 1;

      const bdy = document.createElement('div');
      bdy.className = 'poi-body';

      const name = document.createElement('div');
      name.className = 'poi-name';
      name.textContent = poi.name || 'Unknown location';
      bdy.appendChild(name);

      if (poi.address) {
        const addr = document.createElement('div');
        addr.className = 'poi-address';
        addr.textContent = 'ğŸ“ ' + poi.address;
        bdy.appendChild(addr);
      }

      // Badges
      const meta = document.createElement('div');
      meta.className = 'poi-meta';

      if (poi.is_open === true)  meta.appendChild(badge('âœ… Open',    'badge-open'));
      if (poi.is_open === false) meta.appendChild(badge('âŒ Closed',  'badge-closed'));
      if (poi.is_open === null)  meta.appendChild(badge('â“ Unverified','badge-unknown'));

      if (poi.persona_score != null) {
        const stars = 'â˜…'.repeat(Math.round(poi.persona_score / 2))
                    + 'â˜†'.repeat(5 - Math.round(poi.persona_score / 2));
        meta.appendChild(badge(`${stars} ${poi.persona_score.toFixed(1)}/10`, 'badge-score'));
      }
      bdy.appendChild(meta);

      if (poi.agent_note) {
        const note = document.createElement('div');
        note.className = 'poi-note';
        note.textContent = 'ğŸ¤– ' + poi.agent_note;
        bdy.appendChild(note);
      }

      card.appendChild(num);
      card.appendChild(bdy);
      dayDiv.appendChild(card);
    });

    body.appendChild(dayDiv);
  });

  // Action buttons
  const actions = document.getElementById('actions-row');
  actions.innerHTML = '';

  if (data.pdf_url) {
    const a = document.createElement('a');
    a.href = data.pdf_url; a.target = '_blank';
    a.className = 'btn-secondary';
    a.innerHTML = 'ğŸ“„ Download PDF';
    actions.appendChild(a);
  }
  if (data.map_url) {
    const a = document.createElement('a');
    a.href = data.map_url; a.target = '_blank';
    a.className = 'btn-secondary';
    a.innerHTML = 'ğŸ—ºï¸ Open Route Map';
    actions.appendChild(a);
  }

  const newBtn = document.createElement('button');
  newBtn.className = 'btn-secondary';
  newBtn.innerHTML = 'âœˆï¸ Plan another trip';
  newBtn.onclick = () => {
    document.getElementById('progress-section').style.display = 'none';
    document.getElementById('results-section').style.display  = 'none';
    document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
    resetBtn();
  };
  actions.appendChild(newBtn);

  document.getElementById('results-section').style.display = 'block';
  document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
  document.getElementById('progress-section').style.display = 'none';
  resetBtn();

}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function badge(text, cls) {
  const s = document.createElement('span');
  s.className = `badge ${cls}`;
  s.textContent = text;
  return s;
}

function formatDate(dateStr) {
  try {
    return new Date(dateStr + 'T00:00:00').toLocaleDateString('en', {weekday:'short', month:'short', day:'numeric'});
  } catch { return dateStr; }
}

function showError(msg) {
  const el = document.getElementById('form-error');
  el.textContent = 'âš ï¸ ' + msg;
  el.style.display = 'block';
}

function resetBtn() {
  const b = document.getElementById('plan-btn');
  b.disabled = false;
  b.innerHTML = 'âœˆï¸ Generate my itinerary';
}

</script>
</body>
</html>
